# E2Eテスト - アンケート負荷テスト

## 概要

このディレクトリには、アンケート回答機能の負荷テストが含まれています。Playwrightを使用してブラウザを自動操作し、複数のアンケート回答を並列で送信します。

## セットアップ手順

### 1. 環境変数ファイルの作成

プロジェクトルートで以下のコマンドを実行して、テンプレートから環境変数ファイルを作成します：

```bash
cp .env.test.local.example .env.test.local
```

### 2. アンケートURLの設定

`.env.test.local` ファイルを開き、テスト対象のアンケートURLを設定します：

```bash
SURVEY_URL=http://localhost:3000/survey/<講義ID>
```

**講義IDの取得方法：**

1. アプリケーションを起動: `npm run dev`
2. ブラウザで `http://localhost:3000` にアクセス
3. ログインして講義を作成
4. 作成した講義の詳細ページから講義IDを確認

### 3. テスト実行

#### 開発サーバーの起動

テストを実行する前に、別のターミナルでアプリケーションを起動しておく必要があります：

```bash
npm run dev
```

#### テストの実行

準備ができたら、以下のコマンドでテストを実行します：

```bash
npm run test:e2e
```

#### ヘッド付きモードで実行（デバッグ用）

ブラウザの動作を確認したい場合：

```bash
npx playwright test --headed
```

#### 特定のテストのみ実行

```bash
npx playwright test survey-load-test
```

## テスト仕様

- **テストファイル**: `survey-load-test.spec.ts`
- **テスト件数**: 10件（並列実行）
- **並列ワーカー数**: 3
- **タイムアウト**: 30秒/テスト

### 生成されるテストデータ

- **性別**: ランダム（male, female, other, prefer_not_to_say）
- **年代**: ランダム（under_20, 20s, 30s, 40s, 50s, 60s, over_70）
- **理解度**: 平均4.0程度（3, 4, 4, 5 からランダム選択）
- **満足度**: 平均4.0程度（3, 4, 4, 5 からランダム選択）
- **フリーコメント**: 事前定義されたコメントからランダム選択

## レポート確認

テスト実行後、HTMLレポートで詳細を確認できます：

```bash
npx playwright show-report
```

## トラブルシューティング

### 環境変数が読み込まれない

- `.env.test.local` ファイルがプロジェクトルートに存在するか確認
- ファイル名に typo がないか確認（`.env.test.local`）
- `SURVEY_URL` が正しく設定されているか確認

### テストが失敗する

- 開発サーバーが起動しているか確認（`npm run dev`）
- アンケートURLが正しいか確認
- 講義が「受付中」状態か確認（締切前であること）
- ブラウザのコンソールでエラーがないか確認

### 「要素が見つからない」エラー

- アンケートフォームのHTML構造が変更されていないか確認
- 入力値（性別、年代など）の値が正しいか確認

## 注意事項

⚠️ **重要**:

- `.env.test.local` は Git にコミットしないでください（`.gitignore` に含まれています）
- テストは開発環境でのみ実行してください
- テストを実行すると、実際にデータベースにレコードが作成されます
