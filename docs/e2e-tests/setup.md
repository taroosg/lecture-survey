# E2Eテスト環境セットアップ

## 概要

このドキュメントでは、アンケート配布・回収機能のE2Eテストを実行するための環境セットアップ手順を説明します。

## 前提条件

- Node.js がインストールされていること
- Convex開発環境が設定されていること
- 開発サーバーが起動できる状態であること

---

## 1. テスト用アカウントの作成

開発環境で以下のテストアカウントを作成してください。

### 管理者アカウント

E2Eテストで講義の作成・管理を行うための管理者アカウントが必要です。

**作成手順**:

1. 開発サーバーを起動: `npm run dev`
2. ブラウザで `http://localhost:3000/signin` にアクセス
3. 新規アカウントを作成（または既存の管理者アカウントを使用）
4. 作成したアカウントの情報を記録

**推奨アカウント情報**:

- メールアドレス: `e2e-admin@example.com` など、E2Eテスト専用とわかるもの
- パスワード: 強固なパスワード（開発環境専用）
- ロール: `admin`

⚠️ **注意**: このアカウントは開発環境専用です。本番環境では絶対に使用しないでください。

---

## 2. 環境変数ファイルの作成

### 2.1 テンプレートをコピー

プロジェクトルートで以下のコマンドを実行:

```bash
cp .env.test.local.example .env.test.local
```

### 2.2 認証情報を設定

`.env.test.local` ファイルを開き、作成したテストアカウントの情報を設定します:

```bash
# E2Eテスト用環境変数

# 管理者アカウント（E2Eテスト用）
E2E_ADMIN_EMAIL=e2e-admin@example.com
E2E_ADMIN_PASSWORD=your-actual-password

# 一般ユーザーアカウント（E2Eテスト用、必要な場合）
E2E_USER_EMAIL=e2e-user@example.com
E2E_USER_PASSWORD=your-actual-password

# テスト実行用アプリケーションURL
E2E_BASE_URL=http://localhost:3000
```

---

## 3. セキュリティ上の注意事項

### 🔒 重要な注意点

1. **`.env.test.local` は絶対にGitにコミットしないでください**
   - このファイルは `.gitignore` に登録されています
   - 認証情報が含まれるため、リポジトリに含めてはいけません

2. **開発環境専用**
   - テストアカウントは開発環境（Convex development deployment）でのみ使用
   - 本番環境とは完全に分離してください

3. **認証情報の共有**
   - チーム内で認証情報を共有する必要がある場合は、1Password等の安全な方法を使用してください
   - Slackやメール等で平文で送信しないでください

---

## 4. 開発サーバーの起動

E2Eテストを実行する前に、開発サーバーを起動しておく必要があります。

### 4.1 アプリケーションの起動

```bash
npm run dev
```

### 4.2 起動確認

ブラウザで `http://localhost:3000` にアクセスし、アプリケーションが正常に表示されることを確認してください。

---

## 5. テスト実行の準備完了

以下が揃っていれば、E2Eテストを実行する準備が完了です:

- ✅ テスト用管理者アカウントが作成されている
- ✅ `.env.test.local` ファイルに認証情報が設定されている
- ✅ 開発サーバー（Convex + Next.js）が起動している
- ✅ ブラウザでアプリケーションにアクセスできる

---

## 6. テスト実行方法

E2Eテストの実行方法については、各テストシナリオのドキュメントを参照してください:

- [アンケート配布・回収機能のテスト](./survey-distribution-collection.md)

---

## トラブルシューティング

### 認証エラーが発生する

- `.env.test.local` の認証情報が正しいか確認
- テストアカウントが開発環境に存在するか確認
- ブラウザで手動ログインできるか確認

### サーバーに接続できない

- 開発サーバー（Convex + Next.js）が起動しているか確認
- ポート3000が他のプロセスで使用されていないか確認
- `E2E_BASE_URL` が正しいか確認

### 環境変数が読み込まれない

- `.env.test.local` ファイルがプロジェクトルートに存在するか確認
- ファイル名のタイポがないか確認（`.env.test.local`）
- テスト実行前にサーバーを再起動してみる

---

## 参考情報

- [Playwright Documentation](https://playwright.dev/)
- [Convex Documentation](https://docs.convex.dev/)
- [Next.js Documentation](https://nextjs.org/docs)
